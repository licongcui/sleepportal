<% if @cases and @controls %>
  <% total = @matches.count %>
  <% matched = @matches.select{|match| match[:matching_ids].count == @controls_per_case}.count %>
  <% partial = @matches.select{|match| match[:matching_ids].count > 0 and match[:matching_ids].count < @controls_per_case}.count %>
  <% unmatched = @matches.select{|match| match[:matching_ids].count == 0}.count %>

  <% if total > 0 %>
    <div class="progress">
      <div class="bar bar-success" style="width: <%= "%0.04f" % (matched * 100.0 / total) %>%;"><%= "%0.01f" % (matched * 100.0 / total) %>%</div>
      <div class="bar bar-warning" style="width: <%= "%0.04f" % (partial * 100.0 / total) %>%;"><%= "%0.01f" % (partial * 100.0 / total) %>%</div>
      <div class="bar bar-danger" style="width: <%= "%0.04f" % (unmatched * 100.0 / total) %>%;"><%= "%0.01f" % (unmatched * 100.0 / total) %>%</div>
    </div>
  <% end %>
<div style="clear:both"></div>
<% end %>

<%= link_to 'Download CSV', matching_path(format: 'csv', cases_id: params[:cases_id], controls_id: params[:controls_id], criteria_ids: params[:criteria_ids], variable_ids: params[:variable_ids], controls_per_case: @controls_per_case), class: 'btn' %>

<%= link_to 'Copy Configuration to URL Bar', matching_path(cases_id: params[:cases_id], controls_id: params[:controls_id], criteria_ids: params[:criteria_ids], variable_ids: params[:variable_ids], controls_per_case: @controls_per_case), class: 'btn' %>

<% if @cases and @controls %>
  <table class="table table-striped table-hover" style="width:100%">
    <thead>
      <tr>
        <th>Case ID (<%= @matches.collect{|i| i[:id]}.count %>)</th>
        <th>Control ID<%= 's' if @controls_per_case > 1 %> (<%= @matches.collect{|i| i[:matching_ids]}.flatten.count %>)</th>
        <th>Matched on</th>
      </tr>
    </thead>
    <tbody>
      <% @matches.sort{ |a,b| a[:matching_ids].count <=> b[:matching_ids].count }.each do |match| %>
      <tr class="<%= (match[:matching_ids].count == 0) ? 'error' : (match[:matching_ids].count < @controls_per_case ? 'warning' : nil) %>">
        <td><%= match[:id] %></td>
        <td><%= match[:matching_ids].join(', ') %></td>
        <td><%= match[:criteria].join(', ') %></td>
      </tr>
      <% end %>
    </tbody>
  </table>

<% end %>
